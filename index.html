<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="renderer" content="webkit" />
    <meta http-equiv="content-language" content="zh-cn" />
    <link rel="bookmark" href="{{.favicon}}" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="{{.themeColor}}"
    />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=0"
    />
    <title id="app-title">{{.pageTitle}}</title>
    <meta name="keywords" content="{{.keywords}}" />
    <meta name="description" content="{{.pageDescription}}" />
    <meta name="author" content="{{.author}}" />
    <meta name="theme-color" content="{{.themeColor}}" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta
      name="format-detection"
      content="telephone=no, email=no, address=no"
    />
    <meta name="msapplication-TileColor" content="{{.themeColor}}" />
    <meta name="msapplication-TileImage" content="{{.favicon}}" />
    <link rel="icon" href="{{.favicon}}" />

    <!-- 预加载关键配置文件，减少关键请求链延迟 -->
    <link rel="preload" href="/platform-config.json" as="fetch" crossorigin />

    <!-- Canonical URL for SEO -->
    <link rel="canonical" href="{{.ogUrl}}" />

    <!-- Robots Meta Tag -->
    <meta
      name="robots"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="{{.ogType}}" />
    <meta property="og:url" content="{{.ogUrl}}" />
    <meta property="og:title" content="{{.ogTitle}}" />
    <meta property="og:description" content="{{.ogDescription}}" />
    <meta property="og:image" content="{{.ogImage}}" />
    <meta property="og:site_name" content="{{.ogSiteName}}" />
    <meta property="og:locale" content="{{.ogLocale}}" />
    <meta property="og:theme-color" content="{{.themeColor}}" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="{{.ogUrl}}" />
    <meta name="twitter:title" content="{{.ogTitle}}" />
    <meta name="twitter:description" content="{{.ogDescription}}" />
    <meta name="twitter:image" content="{{.ogImage}}" />

    <!-- -->
    <div style="display: none">
      {{if .articlePublishedTime}}
      <meta
        property="article:published_time"
        content="{{.articlePublishedTime}}"
      />
      {{end}}
      <!--  -->
      {{if .articleModifiedTime}}
      <meta
        property="article:modified_time"
        content="{{.articleModifiedTime}}"
      />
      {{end}}
      <!--  -->
      {{if .articleAuthor}}
      <meta property="article:author" content="{{.articleAuthor}}" />
      {{end}}
      <!--  -->
      {{range .articleTags}}
      <meta property="article:tag" content="{{.}}" />
      {{end}}
    </div>

    <div style="display: none">
      <!-- JSON-LD Structured Data for SEO -->
      {{if .articlePublishedTime}}
      <!-- Article Schema for Blog Posts -->
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": "{{.ogTitle}}",
          "description": "{{.ogDescription}}",
          "image": "{{.ogImage}}",
          "author": {
            "@type": "Person",
            "name": "{{.articleAuthor}}"
          },
          "publisher": {
            "@type": "Organization",
            "name": "{{.ogSiteName}}",
            "logo": {
              "@type": "ImageObject",
              "url": "{{.favicon}}"
            }
          },
          "datePublished": "{{.articlePublishedTime}}",
          "dateModified": "{{.articleModifiedTime}}",
          "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "{{.ogUrl}}"
          }
        }
      </script>
      {{else}}
      <!-- WebSite Schema for Homepage and Other Pages -->
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "WebSite",
          "name": "{{.ogSiteName}}",
          "url": "{{.ogUrl}}",
          "description": "{{.pageDescription}}",
          "publisher": {
            "@type": "Organization",
            "name": "{{.ogSiteName}}",
            "logo": {
              "@type": "ImageObject",
              "url": "{{.favicon}}"
            }
          }
        }
      </script>
      {{end}}
    </div>

    {{if .customHeaderHTML}}
    <!--  -->
    {{.customHeaderHTML}}
    <!--  -->
    {{end}}

    <script>
      window.process = {};

      // 初始化主题
      (function () {
        const isAlbumPage =
          window.location.pathname === "/album" ||
          window.location.pathname.startsWith("/album/");

        // album 页面强制使用暗色主题
        if (isAlbumPage) {
          document.documentElement.setAttribute("data-theme", "dark");
          document.documentElement.classList.add("force-dark");
          return;
        }

        // 读取 localStorage 中保存的主题设置
        try {
          const storageKey = "anheyu-responsive-layout";
          const layoutConfig = localStorage.getItem(storageKey);

          if (layoutConfig) {
            const config = JSON.parse(layoutConfig);
            const overallStyle = config.overallStyle || "light";
            const darkMode = config.darkMode || false;

            let isDark = false;

            if (overallStyle === "system") {
              // 系统主题：使用媒体查询检测
              isDark = window.matchMedia(
                "(prefers-color-scheme: dark)"
              ).matches;
            } else if (overallStyle === "dark") {
              isDark = true;
            } else if (overallStyle === "light") {
              isDark = false;
            } else {
              // 兼容旧版本，使用 darkMode 属性
              isDark = darkMode;
            }

            // 应用主题
            document.documentElement.setAttribute(
              "data-theme",
              isDark ? "dark" : "light"
            );
            document.documentElement.classList.add(isDark ? "dark" : "light");
          }
        } catch (e) {
          // 如果读取失败，使用系统主题
          const isDark = window.matchMedia(
            "(prefers-color-scheme: dark)"
          ).matches;
          document.documentElement.setAttribute(
            "data-theme",
            isDark ? "dark" : "light"
          );
          document.documentElement.classList.add(isDark ? "dark" : "light");
        }
      })();
    </script>
  </head>

  <body>
    <div id="app">
      <style>
        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }

        :root {
          --background: #121621;
          --text-color: #9ca3af;
          --primary: rgb(39 94 254 / 100%);
          --loader-bg: rgba(39, 94, 254, 0.2);
        }

        /* 浅色主题 */
        @media (prefers-color-scheme: light) {
          :root {
            --background: #f5f5f5;
            --text-color: #6b7280;
          }
        }

        /* 支持通过 HTML 类名手动控制主题 */
        html.light,
        html[data-theme="light"] {
          --background: #f5f5f5;
          --text-color: #6b7280;
        }

        html.dark,
        html[data-theme="dark"] {
          --background: #121621;
          --text-color: #9ca3af;
        }

        /* 强制暗色主题（用于特殊页面如 /album） */
        html.force-dark,
        html.force-dark[data-theme="light"] {
          --background: #121621 !important;
          --text-color: #9ca3af !important;
        }

        html {
          box-sizing: border-box;
          -webkit-font-smoothing: antialiased;
        }

        * {
          box-sizing: inherit;
        }

        *::before,
        *::after {
          box-sizing: inherit;
        }

        body {
          min-height: 100vh;
          margin: 0;
          background: var(--background);
          transition: background-color 0.3s ease;
        }

        /* 加载状态：覆盖整个视口的固定层 */
        #app::before {
          content: "";
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          background: var(--background);
          z-index: 9999;
          pointer-events: none;
          opacity: 1;
          transition: opacity 0.3s ease-out;
        }

        /* Vue 挂载后隐藏加载层 */
        #app[data-loaded="true"]::before {
          opacity: 0;
        }

        /* 初始加载时隐藏实际内容 */
        #app > :not(.loader):not(small) {
          opacity: 0;
          transition: opacity 0.3s ease-in;
        }

        /* Vue 挂载后显示实际内容 */
        #app[data-loaded="true"] > :not(.loader):not(small) {
          opacity: 1;
        }

        /* 加载器容器 - 固定在视口中心 */
        #app {
          min-height: 100vh;
        }

        #app > .loader,
        #app > small {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 10000;
        }

        #app > small {
          top: calc(50% + 60px);
          transform: translateX(-50%);
        }

        /* Vue 挂载后隐藏加载器 */
        #app[data-loaded="true"] > .loader,
        #app[data-loaded="true"] > small {
          display: none;
        }

        .loader {
          width: 60px;
          height: 60px;
          border: 6px solid var(--loader-bg);
          border-top: 6px solid var(--primary);
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }

        small {
          display: block;
          max-width: 320px;
          font-size: 12px;
          line-height: 19px;
          color: var(--text-color);
          text-align: center;
          transition: color 0.3s ease;
        }

        @media (width <= 480px) {
          .loader {
            width: 48px;
            height: 48px;
            border-width: 5px;
          }

          small {
            max-width: 90%;
            font-size: 10px;
            line-height: 17px;
          }
        }
      </style>
      <div class="loader"></div>
      <small id="app-small-text"></small>
    </div>

    <script>
      window.__INITIAL_DATA__ = {{json .initialData}};
    </script>
    <script type="module" src="/src/main.ts"></script>

    {{if .customFooterHTML}}
    <!-- -->
    {{.customFooterHTML}}
    <!--  -->
    {{end}}
  </body>
</html>
